<div class="container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>المزارع</mat-card-title>
      <mat-card-subtitle>إدارة بيانات المزارع والموردين</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="actions-bar">
        <button mat-raised-button color="primary" (click)="openAddDialog()">
          <mat-icon>add</mat-icon>
          إضافة مزرعة
        </button>
      </div>
      <!-- Filters -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">بحث</label>
            <input type="text" [(ngModel)]="searchTermModel" (ngModelChange)="onSearchChange($event)"
              placeholder="ابحث بالاسم أو مالك المزرعة..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">الحالة المالية</label>
            <select [(ngModel)]="debtFilterModel" (ngModelChange)="onDebtFilterChange()"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">الكل</option>
              <option value="with_debt">عليه دين</option>
              <option value="no_debt">عليا دين</option>
            </select>
          </div>


          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">عدد النتائج</label>
            <select [(ngModel)]="pageSizeModel" (ngModelChange)="onPageSizeChange()"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>
      </div>

      @if (loading()) {
      <div class="loading-spinner">
        <mat-spinner></mat-spinner>
      </div>
      } @else {
      <div class="table-container">
        <table mat-table [dataSource]="farms()">
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>اسم المزرعة</th>
            <td mat-cell *matCellDef="let farm">{{ farm.name }}</td>
          </ng-container>

          <ng-container matColumnDef="owner_name">
            <th mat-header-cell *matHeaderCellDef>المالك</th>
            <td mat-cell *matCellDef="let farm">{{ farm.owner_name || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="phone">
            <th mat-header-cell *matHeaderCellDef>الهاتف</th>
            <td mat-cell *matCellDef="let farm">{{ formatNumber(farm.phone) || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef>الموقع</th>
            <td mat-cell *matCellDef="let farm">{{ farm.location || '-' }}</td>
          </ng-container>

          <ng-container matColumnDef="total_debt">
            <th mat-header-cell *matHeaderCellDef>الدين</th>
            <td mat-cell *matCellDef="let farm">
              <mat-chip [ngClass]="farm.current_balance > 0 ? 'debt-chip green' : 'debt-chip red'">
                {{ formatCurrency(Math.abs(farm.current_balance)) }}
                {{ farm.current_balance > 0 ? '' : 'ج عليا' }}
              </mat-chip>
            </td>

          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>الإجراءات</th>
            <td mat-cell *matCellDef="let farm">
              <button mat-icon-button (click)="viewDebtHistory(farm)">
                <mat-icon>history</mat-icon>
              </button>
              <button mat-icon-button (click)="openEditDialog(farm)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="deleteFarm(farm)">
                <mat-icon color="warn">delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>
      <!-- Pagination -->
      <div
        class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-4 rounded-lg shadow">
        <div class="flex-1 flex justify-between sm:hidden">
          <button (click)="previousPage()" [disabled]="currentPage() === 1"
            class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
            السابق
          </button>
          <button (click)="nextPage()" [disabled]="currentPage() === totalPages()"
            class="mr-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
            التالي
          </button>
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
          <div>
            <p class="text-sm text-gray-700">
              عرض
              <span class="font-medium mx-1">{{ (currentPage() - 1) * pageSize() + 1 }}</span>
              إلى
              <span class="font-medium mx-1">{{ Math.min(currentPage() * pageSize(), totalFarms()) }}</span>
              من
              <span class="font-medium mx-1">{{ totalFarms() }}</span>
              مزرعه
            </p>
          </div>
          <div>
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
              <button (click)="previousPage()" [disabled]="currentPage() === 1"
                class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                <span class="sr-only">السابق</span>
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                    clip-rule="evenodd" />
                </svg>
              </button>
              <span
                class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                صفحة {{ currentPage() }} من {{ totalPages() }}
              </span>
              <button (click)="nextPage()" [disabled]="currentPage() === totalPages()"
                class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                <span class="sr-only">التالي</span>
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd"
                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                    clip-rule="evenodd" />
                </svg>
              </button>
            </nav>
          </div>
        </div>
      </div>
      }
    </mat-card-content>
  </mat-card>
</div>
