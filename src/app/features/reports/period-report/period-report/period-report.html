<div class="container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>تقرير الفترة</mat-card-title>
      <mat-card-subtitle>عرض تفاصيل العمليات خلال فترة محددة</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="periodForm" (ngSubmit)="loadReport()">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>من تاريخ</mat-label>
            <input matInput [matDatepicker]="pickerFrom" formControlName="from">
            <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
            <mat-datepicker #pickerFrom></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>إلى تاريخ</mat-label>
            <input matInput [matDatepicker]="pickerTo" formControlName="to">
            <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
            <mat-datepicker #pickerTo></mat-datepicker>
          </mat-form-field>

          <button mat-raised-button color="primary" type="submit">
            عرض التقرير
          </button>
        </div>
      </form>

      @if (loading()) {
      <div class="loading-spinner">
        <mat-spinner></mat-spinner>
      </div>
      } @else if (report()) {
      <div class="report-content">
        <!-- Period Info -->
        <div class="period-info">
          <h3>الفترة: من {{ report()!.period.from }} إلى {{ report()!.period.to }}</h3>
          <p>عدد أيام التشغيل: {{ report()!.totals.days_operated }}</p>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
          <h3>الملخص المالي للفترة</h3>
          <div class="summary-grid">
            <div class="summary-card">
              <p class="label">إجمالي المشتريات</p>
              <p class="value">{{ report()!.totals.total_purchases | number:'1.2-2' }} ج</p>
            </div>
            <div class="summary-card">
              <p class="label">إجمالي المبيعات</p>
              <p class="value">{{ report()!.totals.total_sales | number:'1.2-2' }} ج</p>
            </div>
            <div class="summary-card">
              <p class="label">التكاليف</p>
              <p class="value">{{ report()!.totals.total_costs | number:'1.2-2' }} ج</p>
            </div>
            <div class="summary-card">
              <p class="label">الخسائر</p>
              <p class="value">{{ report()!.totals.total_losses | number:'1.2-2' }} ج</p>
            </div>
            <div class="summary-card profit">
              <p class="label">صافي الربح</p>
              <p class="value">{{ report()!.totals.total_profit | number:'1.2-2' }} ج</p>
            </div>
          </div>
        </div>

        <!-- Operations by Date -->
        <div class="operations-section">
          <h3>تفاصيل العمليات اليومية</h3>

          @for (operation of report()!.operations; track operation.operation_id) {
          <mat-card class="operation-card">
            <mat-card-header>
              <mat-card-title>{{ operation.operation_date }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <!-- Farm Transactions -->
              @if (operation.FarmTransactions && operation.FarmTransactions.length > 0) {
              <h4>معاملات المزارع</h4>
              <table mat-table [dataSource]="operation.FarmTransactions" class="details-table">
                <ng-container matColumnDef="farm">
                  <th mat-header-cell *matHeaderCellDef>المزرعة</th>
                  <td mat-cell *matCellDef="let tx">{{ tx.Farm?.name }}</td>
                </ng-container>

                <ng-container matColumnDef="chicken_type">
                  <th mat-header-cell *matHeaderCellDef>نوع الفراخ</th>
                  <td mat-cell *matCellDef="let tx">{{ tx.ChickenType?.name }}</td>
                </ng-container>

                <ng-container matColumnDef="weight">
                  <th mat-header-cell *matHeaderCellDef>الوزن</th>
                  <td mat-cell *matCellDef="let tx">{{ tx.net_chicken_weight }} كجم</td>
                </ng-container>

                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>المبلغ</th>
                  <td mat-cell *matCellDef="let tx">{{ tx.total_amount | number:'1.2-2' }} ج</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="farmColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: farmColumns"></tr>
              </table>
              }

              <!-- Sale Transactions -->
              @if (operation.SaleTransactions && operation.SaleTransactions.length > 0) {
              <h4>معاملات المبيعات</h4>
              <table mat-table [dataSource]="operation.SaleTransactions" class="details-table">
                <ng-container matColumnDef="buyer">
                  <th mat-header-cell *matHeaderCellDef>المشتري</th>
                  <td mat-cell *matCellDef="let sale">{{ sale.Buyer?.name }}</td>
                </ng-container>

                <ng-container matColumnDef="chicken_type">
                  <th mat-header-cell *matHeaderCellDef>نوع الفراخ</th>
                  <td mat-cell *matCellDef="let sale">{{ sale.ChickenType?.name }}</td>
                </ng-container>

                <ng-container matColumnDef="weight">
                  <th mat-header-cell *matHeaderCellDef>الوزن</th>
                  <td mat-cell *matCellDef="let sale">{{ sale.net_chicken_weight }} كجم</td>
                </ng-container>

                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>المبلغ</th>
                  <td mat-cell *matCellDef="let sale">{{ sale.total_amount | number:'1.2-2' }} ج</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="saleColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: saleColumns"></tr>
              </table>
              }

              <!-- Daily Costs -->
              @if (operation.DailyCosts && operation.DailyCosts.length > 0) {
              <h4>التكاليف اليومية</h4>
              <table mat-table [dataSource]="operation.DailyCosts" class="details-table">
                <ng-container matColumnDef="category">
                  <th mat-header-cell *matHeaderCellDef>الفئة</th>
                  <td mat-cell *matCellDef="let cost">{{ cost.CostCategory?.name }}</td>
                </ng-container>

                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>المبلغ</th>
                  <td mat-cell *matCellDef="let cost">{{ cost.amount | number:'1.2-2' }} ج</td>
                </ng-container>

                <ng-container matColumnDef="notes">
                  <th mat-header-cell *matHeaderCellDef>ملاحظات</th>
                  <td mat-cell *matCellDef="let cost">{{ cost.notes || '-' }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="costColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: costColumns"></tr>
              </table>
              }

              <!-- Transport Losses -->
              @if (operation.TransportLosses && operation.TransportLosses.length > 0) {
              <h4>خسائر النقل</h4>
              <table mat-table [dataSource]="operation.TransportLosses" class="details-table">
                <ng-container matColumnDef="chicken_type">
                  <th mat-header-cell *matHeaderCellDef>نوع الفراخ</th>
                  <td mat-cell *matCellDef="let loss">{{ loss.ChickenType?.name }}</td>
                </ng-container>

                <ng-container matColumnDef="weight">
                  <th mat-header-cell *matHeaderCellDef>الوزن المفقود</th>
                  <td mat-cell *matCellDef="let loss">{{ loss.dead_weight }} كجم</td>
                </ng-container>

                <ng-container matColumnDef="amount">
                  <th mat-header-cell *matHeaderCellDef>قيمة الخسارة</th>
                  <td mat-cell *matCellDef="let loss">{{ loss.loss_amount | number:'1.2-2' }} ج</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="lossColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: lossColumns"></tr>
              </table>
              }

              <!-- Profit Distribution -->
              @if (operation.ProfitDistribution) {
              <div class="profit-info">
                <p><strong>صافي الربح لهذا اليوم:</strong> {{ operation.ProfitDistribution.net_profit | number:'1.2-2'
                  }} ج</p>
              </div>
              }
            </mat-card-content>
          </mat-card>
          }
        </div>
      </div>
      }
    </mat-card-content>
  </mat-card>
</div>