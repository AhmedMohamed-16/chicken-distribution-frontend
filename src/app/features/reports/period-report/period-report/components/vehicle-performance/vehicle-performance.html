<div class="vehicle-performance">

  <!-- Summary Cards -->
  <div class="summary-grid">
    <mat-card class="summary-card">
      <mat-icon class="card-icon">local_shipping</mat-icon>
      <div class="card-content">
        <span class="card-label">إجمالي المركبات</span>
        <span class="card-value">{{ formatNumber(performance().summary.total_vehicles, 0) }}</span>
      </div>
    </mat-card>

    <mat-card class="summary-card best">
      <mat-icon class="card-icon">emoji_events</mat-icon>
      <div class="card-content">
        <span class="card-label">أفضل مركبة</span>
        <span class="card-value">{{ getBestVehicleName() }}</span>
      </div>
    </mat-card>

    <mat-card class="summary-card variance">
      <mat-icon class="card-icon">trending_up</mat-icon>
      <div class="card-content">
        <span class="card-label">فارق الأداء</span>
        <span class="card-value">{{ formatCurrency(performance().summary.profit_variance_high_to_low) }} ج</span>
      </div>
    </mat-card>
  </div>

  <!-- Vehicle Ranking Table -->
  <mat-card class="ranking-card">
    <mat-card-header>
      <mat-icon class="section-icon">leaderboard</mat-icon>
      <mat-card-title>تصنيف أداء المركبات</mat-card-title>
      <mat-card-subtitle>مرتبة حسب صافي الربح</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="performance().vehicles" class="performance-table">

        <!-- Rank Column -->
        <ng-container matColumnDef="rank">
          <th mat-header-cell *matHeaderCellDef>الترتيب</th>
          <td mat-cell *matCellDef="let vehicle">
            <div class="rank-badge" [class]="getRankClass(vehicle.rank)">
              @if (vehicle.rank <= 3) {
                <mat-icon>{{ getRankIcon(vehicle.rank) }}</mat-icon>
              } @else {
                <span>{{ formatNumber(vehicle.rank, 0) }}</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Vehicle Column -->
        <ng-container matColumnDef="vehicle">
          <th mat-header-cell *matHeaderCellDef>المركبة</th>
          <td mat-cell *matCellDef="let vehicle">
            <div class="vehicle-info">
              <strong>{{ vehicle.vehicle_name }}</strong>
              <span class="plate-number">{{ formatNumber(vehicle.plate_number )}}</span>
            </div>
          </td>
        </ng-container>

        <!-- Days Operated Column -->
        <ng-container matColumnDef="days">
          <th mat-header-cell *matHeaderCellDef>أيام العمل</th>
          <td mat-cell *matCellDef="let vehicle">{{ formatNumber(vehicle.days_operated, 0) }}</td>
        </ng-container>

        <!-- Revenue Column -->
        <ng-container matColumnDef="revenue">
          <th mat-header-cell *matHeaderCellDef>الإيرادات</th>
          <td mat-cell *matCellDef="let vehicle">{{ formatCurrency(vehicle.total_revenue) }} ج</td>
        </ng-container>

        <!-- Net Profit Column -->
        <ng-container matColumnDef="profit">
          <th mat-header-cell *matHeaderCellDef>صافي الربح</th>
          <td mat-cell *matCellDef="let vehicle">
            <span [class.profit]="vehicle.net_profit > 0" [class.loss]="vehicle.net_profit < 0">
              {{ formatCurrency(vehicle.net_profit) }} ج
            </span>
          </td>
        </ng-container>

        <!-- Profit Margin Column -->
        <ng-container matColumnDef="margin">
          <th mat-header-cell *matHeaderCellDef>هامش الربح</th>
          <td mat-cell *matCellDef="let vehicle">{{ formatPercentage(vehicle.profit_margin_pct, 1) }}%</td>
        </ng-container>

        <!-- Average Daily Profit Column -->
        <ng-container matColumnDef="avgDaily">
          <th mat-header-cell *matHeaderCellDef>متوسط ربح يومي</th>
          <td mat-cell *matCellDef="let vehicle">{{ formatCurrency(vehicle.avg_daily_profit) }} ج</td>
        </ng-container>

        <!-- Performance Rating Column -->
        <ng-container matColumnDef="rating">
          <th mat-header-cell *matHeaderCellDef>التقييم</th>
          <td mat-cell *matCellDef="let vehicle">
            <mat-chip [class]="getRatingClass(vehicle.performance_rating)">
              {{ getRatingLabel(vehicle.performance_rating) }}
            </mat-chip>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.top-performer]="row.rank === 1"></tr>
      </table>
    </mat-card-content>
  </mat-card>

</div>
